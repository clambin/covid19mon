include:
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/python38/python-tests.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/k3s-docker-build-multiarch.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/k3s-deploy.yml'

stages:
  - unittest
  - build
  - release
  - deploy

variables:
  POSTGRES_HOST: postgres
  POSTGRES_PORT: 5432
  POSTGRES_DB: covid19
  POSTGRES_USER: covid
  POSTGRES_PASSWORD: example

services:
  - postgres

pytest:
  stage: unittest
  image: python:3.8
  before_script:
    - pip install pipenv
    - pipenv install --dev
    - export PYTHONPATH=$(pwd)
    - export POSTGRES_HOST POSTGRES_PORT POSTGRES_DB POSTGRES_USER POSTGRES_PASSWORD API_KEY
  script:
    - cd tests && pipenv run pytest --cov --junitxml=report.xml
    - pipenv run bash <(curl -s https://codecov.io/bash) -s tests
  artifacts:
    reports:
      junit: tests/report.xml

prometheus:
  stage: unittest
  image: python:3.7
  before_script:
    - pip install pipenv
    - pipenv install
  script:
    - pipenv run python covid19.py --apikey=$APIKEY &
    - COVID19=$?
    - sleep 10
    - curl -s localhost:8080/metric | grep '^request_processing_seconds_count{endpoint="v1/stats",server="https://covid-19-coronavirus-statistics.p.rapidapi.com/"}'
