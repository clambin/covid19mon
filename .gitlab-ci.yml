include:
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/python-tests.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/docker-build-multiarch.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/docker-swarm-deploy.yml'
  - remote: 'https://gitlab.com/clambin/gitlab-ci-templates/raw/master/github.yml'

stages:
  - unittest
  - qa
  - build
  - release
  - deploy

variables:
  VERSION: '0.2'

# Don't run for new tags
workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - when: always

pytest:
  before_script:
    - echo No unit tests defined
    - return 0
  artifacts:
    reports:
      junit: []

prometheus:
  stage: qa
  image: python3.7
  before_script:
    #- apk add --update curl
    - pip install pipenv
    - pipenv install
  script:
    - export API_KEY
    - pipenv run python covid19.py &
    - COVID19=$?
    - sleep 10
    - curl -s localhost:8080/metric | grep '^request_processing_seconds_count{endpoint="v1/stats",server="https://covid-19-coronavirus-statistics.p.rapidapi.com/"}'
    - kill $COVID19
